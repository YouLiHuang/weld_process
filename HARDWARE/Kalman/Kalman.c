/*
 * @Author: huangyouli.scut@gmail.com
 * @Date: 2024-12-05 09:43:02
 * @LastEditors: YouLiHuang huangyouli.scut@gmail.com
 * @LastEditTime: 2025-03-19 09:11:31
 * @Description:
 *
 * Copyright (c) 2024 by huangyouli, All Rights Reserved.
 */
#include "Kalman.h"

void Kalman_Init(Kalman *kfp)
{
   kfp->Last_P = 1;
   kfp->Now_P = 0;
   kfp->out = 0;
   kfp->Kg = 0;
   kfp->Q = 0.001; // 0.001
   kfp->R = 0.5;   // 0.01
}

float KalmanFilter(Kalman *kfp, float input)
{
   // Ô¤ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½î·½ï¿½Ì£ï¿½kÊ±ï¿½ï¿½ÏµÍ³ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½ï¿½ = k-1Ê±ï¿½Ìµï¿½ÏµÍ³Ğ­ï¿½ï¿½ï¿½ï¿½ + ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½ï¿½
   kfp->Now_P = kfp->Last_P + kfp->Q;
   // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ·½ï¿½Ì£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ = kÊ±ï¿½ï¿½ÏµÍ³ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½ï¿½ / ï¿½ï¿½kÊ±ï¿½ï¿½ÏµÍ³ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½ï¿½ + ï¿½Û²ï¿½ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½î£©
   kfp->Kg = kfp->Now_P / (kfp->Now_P + kfp->R);
   // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½Ì£ï¿½kÊ±ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Öµ = ×´Ì¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¤ï¿½ï¿½Öµ + ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Öµ - ×´Ì¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¤ï¿½ï¿½Öµï¿½ï¿½
   kfp->out = kfp->out + kfp->Kg * (input - kfp->out); // ï¿½ï¿½Îªï¿½ï¿½Ò»ï¿½Îµï¿½Ô¤ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½Îµï¿½ï¿½ï¿½ï¿½Ö?
   // ï¿½ï¿½ï¿½ï¿½Ğ­ï¿½ï¿½ï¿½î·½ï¿½ï¿½: ï¿½ï¿½ï¿½Îµï¿½ÏµÍ³Ğ­ï¿½ï¿½ï¿½î¸¶ï¿½ï¿½ kfp->LastP Îªï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×¼ï¿½ï¿½ï¿½ï¿½
   kfp->Last_P = (1 - kfp->Kg) * kfp->Now_P;
   return kfp->out;
}
